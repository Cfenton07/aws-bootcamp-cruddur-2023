#!/usr/bin/env bash
set -e

echo "üöÄ Deploying Backend to ECS Fargate..."

# Variables
VPC_ID="vpc-0a1dc40aa792a3571"
ALB_SG_ID="sg-0e76f2452d3fbd76c"
ECS_SG_ID="sg-0d67270f3a5014e4b"
SUBNET_1="subnet-0eec24f1dc6304365"   # us-east-1a
SUBNET_2="subnet-02a4b96627ce17386"   # us-east-1b
SUBNET_3="subnet-0ee09cd6302be019c"   # us-east-1c
CLUSTER_NAME="cruddur"

# Step 1: Create Target Group
echo "üìé Creating Target Group..."
TG_ARN=$(aws elbv2 create-target-group \
  --name cruddur-backend-flask-tg \
  --protocol HTTP \
  --port 4567 \
  --vpc-id $VPC_ID \
  --target-type ip \
  --health-check-protocol HTTP \
  --health-check-path "/api/health-check" \
  --health-check-interval-seconds 30 \
  --health-check-timeout-seconds 5 \
  --healthy-threshold-count 2 \
  --unhealthy-threshold-count 2 \
  --query "TargetGroups[0].TargetGroupArn" \
  --output text)
echo "‚úÖ Target Group ARN: $TG_ARN"

# Step 2: Create ALB
echo "‚öñÔ∏è Creating Application Load Balancer..."
ALB_ARN=$(aws elbv2 create-load-balancer \
  --name cruddur-alb \
  --subnets $SUBNET_1 $SUBNET_2 $SUBNET_3 \
  --security-groups $ALB_SG_ID \
  --scheme internet-facing \
  --type application \
  --ip-address-type ipv4 \
  --query "LoadBalancers[0].LoadBalancerArn" \
  --output text)
echo "‚úÖ ALB ARN: $ALB_ARN"

# Get ALB DNS name
ALB_DNS=$(aws elbv2 describe-load-balancers \
  --load-balancer-arns $ALB_ARN \
  --query "LoadBalancers[0].DNSName" \
  --output text)
echo "üåê ALB DNS: $ALB_DNS"

# Wait for ALB to be active
echo "‚è≥ Waiting for ALB to become active..."
aws elbv2 wait load-balancer-available --load-balancer-arns $ALB_ARN
echo "‚úÖ ALB is active"

# Step 3: Create Listener
echo "üëÇ Creating Listener..."
LISTENER_ARN=$(aws elbv2 create-listener \
  --load-balancer-arn $ALB_ARN \
  --protocol HTTP \
  --port 80 \
  --default-actions Type=forward,TargetGroupArn=$TG_ARN \
  --query "Listeners[0].ListenerArn" \
  --output text)
echo "‚úÖ Listener ARN: $LISTENER_ARN"

# Step 4: Create ECS Service
echo "üê≥ Creating ECS Service..."
aws ecs create-service \
  --cluster $CLUSTER_NAME \
  --service-name backend-flask \
  --task-definition backend-flask \
  --desired-count 1 \
  --launch-type FARGATE \
  --network-configuration "awsvpcConfiguration={subnets=[$SUBNET_1,$SUBNET_2,$SUBNET_3],securityGroups=[$ECS_SG_ID],assignPublicIp=ENABLED}" \
  --load-balancers "targetGroupArn=$TG_ARN,containerName=backend-flask,containerPort=4567" \
  --enable-execute-command \
  --query "service.serviceName" \
  --output text

echo ""
echo "üéâ Deployment complete!"
echo "üåê Your backend will be available at: http://$ALB_DNS/api/health-check"
echo "‚è≥ Wait ~2 minutes for the task to start and register with the target group"

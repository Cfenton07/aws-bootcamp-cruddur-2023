#!/usr/bin/env bash
set -e

echo "ğŸš€ Deploying Backend to ECS Fargate..."

# ========================================
# VARIABLES
# ========================================
VPC_ID="vpc-0a1dc40aa792a3571"
ALB_SG_ID="sg-0e76f2452d3fbd76c"
ECS_SG_ID="sg-0d67270f3a5014e4b"
SUBNET_1="subnet-0eec24f1dc6304365"
SUBNET_2="subnet-02a4b96627ce17386"
SUBNET_3="subnet-0ee09cd6302be019c"
CLUSTER_NAME="cruddur"

# ========================================
# STEP 1: TARGET GROUP
# ========================================
echo "ğŸ“ Checking Target Group..."

TG_ARN=$(aws elbv2 describe-target-groups \
  --names cruddur-backend-flask-tg \
  --query "TargetGroups[0].TargetGroupArn" \
  --output text 2>/dev/null || echo "")

if [ -z "$TG_ARN" ] || [ "$TG_ARN" == "None" ]; then
  echo "   Creating Target Group..."
  TG_ARN=$(aws elbv2 create-target-group \
    --name cruddur-backend-flask-tg \
    --protocol HTTP \
    --port 4567 \
    --vpc-id $VPC_ID \
    --target-type ip \
    --health-check-protocol HTTP \
    --health-check-path "/api/health-check" \
    --health-check-interval-seconds 30 \
    --health-check-timeout-seconds 5 \
    --healthy-threshold-count 2 \
    --unhealthy-threshold-count 2 \
    --query "TargetGroups[0].TargetGroupArn" \
    --output text)
  echo "âœ… Created Target Group: $TG_ARN"
else
  echo "âœ… Target Group exists: $TG_ARN"
fi

# ========================================
# STEP 2: APPLICATION LOAD BALANCER
# ========================================
echo "âš–ï¸  Checking ALB..."

ALB_ARN=$(aws elbv2 describe-load-balancers \
  --names cruddur-alb \
  --query "LoadBalancers[0].LoadBalancerArn" \
  --output text 2>/dev/null || echo "")

if [ -z "$ALB_ARN" ] || [ "$ALB_ARN" == "None" ]; then
  echo "   Creating ALB..."
  ALB_ARN=$(aws elbv2 create-load-balancer \
    --name cruddur-alb \
    --subnets $SUBNET_1 $SUBNET_2 $SUBNET_3 \
    --security-groups $ALB_SG_ID \
    --scheme internet-facing \
    --type application \
    --ip-address-type ipv4 \
    --query "LoadBalancers[0].LoadBalancerArn" \
    --output text)
  echo "âœ… Created ALB: $ALB_ARN"
  
  echo "â³ Waiting for ALB to become active..."
  aws elbv2 wait load-balancer-available --load-balancer-arns $ALB_ARN
  echo "âœ… ALB is active"
else
  echo "âœ… ALB exists: $ALB_ARN"
fi

# Get ALB DNS
ALB_DNS=$(aws elbv2 describe-load-balancers \
  --load-balancer-arns $ALB_ARN \
  --query "LoadBalancers[0].DNSName" \
  --output text)
echo "ğŸŒ ALB DNS: $ALB_DNS"

# ========================================
# STEP 3: LISTENERS
# ========================================
echo "ğŸ‘‚ Checking Listeners..."

CERT_ARN="arn:aws:acm:us-east-1:931637612335:certificate/fe029e37-b6c8-409f-b6b2-bf37aea9dcfb"

# First: Get or create HTTP listener on port 80
HTTP_LISTENER_ARN=$(aws elbv2 describe-listeners \
  --load-balancer-arn $ALB_ARN \
  --query "Listeners[?Port==\`80\`].ListenerArn" \
  --output text 2>/dev/null || echo "")

if [ -z "$HTTP_LISTENER_ARN" ] || [ "$HTTP_LISTENER_ARN" == "None" ]; then
  echo "   Creating HTTP Listener..."
  HTTP_LISTENER_ARN=$(aws elbv2 create-listener \
    --load-balancer-arn $ALB_ARN \
    --protocol HTTP \
    --port 80 \
    --default-actions Type=redirect,RedirectConfig="{Protocol=HTTPS,Port=443,StatusCode=HTTP_301}" \
    --query "Listeners[0].ListenerArn" \
    --output text)
  echo "âœ… Created HTTP Listener: $HTTP_LISTENER_ARN"
else
  echo "   Updating HTTP Listener to redirect to HTTPS..."
  aws elbv2 modify-listener \
    --listener-arn $HTTP_LISTENER_ARN \
    --default-actions Type=redirect,RedirectConfig="{Protocol=HTTPS,Port=443,StatusCode=HTTP_301}" > /dev/null
  echo "âœ… HTTP Listener updated"
fi

# Second: Get or create HTTPS listener on port 443
HTTPS_LISTENER_ARN=$(aws elbv2 describe-listeners \
  --load-balancer-arn $ALB_ARN \
  --query "Listeners[?Port==\`443\`].ListenerArn" \
  --output text 2>/dev/null || echo "")

if [ -z "$HTTPS_LISTENER_ARN" ] || [ "$HTTPS_LISTENER_ARN" == "None" ]; then
  echo "   Creating HTTPS Listener..."
  HTTPS_LISTENER_ARN=$(aws elbv2 create-listener \
    --load-balancer-arn $ALB_ARN \
    --protocol HTTPS \
    --port 443 \
    --certificates CertificateArn=$CERT_ARN \
    --default-actions Type=forward,TargetGroupArn=$TG_ARN \
    --query "Listeners[0].ListenerArn" \
    --output text)
  echo "âœ… Created HTTPS Listener: $HTTPS_LISTENER_ARN"
else
  echo "âœ… HTTPS Listener exists: $HTTPS_LISTENER_ARN"
fi

# ========================================
# STEP 4: ECS SERVICE
# ========================================
echo "ğŸ³ Checking ECS Service..."

SERVICE_STATUS=$(aws ecs describe-services \
  --cluster $CLUSTER_NAME \
  --services backend-flask \
  --query "services[0].status" \
  --output text 2>/dev/null || echo "")

if [ -z "$SERVICE_STATUS" ] || [ "$SERVICE_STATUS" == "None" ] || [ "$SERVICE_STATUS" == "INACTIVE" ]; then
  echo "   Creating ECS Service..."
  aws ecs create-service \
    --cluster $CLUSTER_NAME \
    --service-name backend-flask \
    --task-definition backend-flask \
    --desired-count 1 \
    --launch-type FARGATE \
    --network-configuration "awsvpcConfiguration={subnets=[$SUBNET_1,$SUBNET_2,$SUBNET_3],securityGroups=[$ECS_SG_ID],assignPublicIp=ENABLED}" \
    --load-balancers "targetGroupArn=$TG_ARN,containerName=backend-flask,containerPort=4567" \
    --enable-execute-command \
    --query "service.serviceName" \
    --output text
  echo "âœ… Created ECS Service"
else
  echo "âœ… ECS Service exists (status: $SERVICE_STATUS)"
  
  # Ensure desired count is 1
  aws ecs update-service \
    --cluster $CLUSTER_NAME \
    --service backend-flask \
    --desired-count 1 \
    --query "service.serviceName" \
    --output text > /dev/null
  echo "   Updated desired count to 1"
fi

echo ""
echo "ğŸ‰ Backend deployment complete!"
echo ""
echo "ğŸŒ Your backend will be available at: http://$ALB_DNS/api/health-check"
echo "â³ Wait ~2 minutes for the task to start and register with the target group"

#!/usr/bin/env bash
set -e

echo "ğŸš€ Deploying Frontend to ECS Fargate..."

# ========================================
# VARIABLES
# ========================================
VPC_ID="vpc-0a1dc40aa792a3571"
ECS_SG_ID="sg-0d67270f3a5014e4b"
SUBNET_1="subnet-0eec24f1dc6304365"
SUBNET_2="subnet-02a4b96627ce17386"
SUBNET_3="subnet-0ee09cd6302be019c"
CLUSTER_NAME="cruddur"

# ========================================
# CHECK IF ALB EXISTS (Backend must be deployed first)
# ========================================
echo "ğŸ” Checking for existing ALB..."

ALB_ARN=$(aws elbv2 describe-load-balancers \
  --names cruddur-alb \
  --query "LoadBalancers[0].LoadBalancerArn" \
  --output text 2>/dev/null || echo "")

if [ -z "$ALB_ARN" ] || [ "$ALB_ARN" == "None" ]; then
  echo "âŒ ALB 'cruddur-alb' not found!"
  echo ""
  echo "Please deploy the backend first:"
  echo "  ./bin/ecs/deploy-backend"
  exit 1
fi

echo "âœ… Found ALB: $ALB_ARN"

# Get ALB DNS
ALB_DNS=$(aws elbv2 describe-load-balancers \
  --load-balancer-arns $ALB_ARN \
  --query "LoadBalancers[0].DNSName" \
  --output text)
echo "ğŸŒ ALB DNS: $ALB_DNS"

# ========================================
# GET HTTPS LISTENER (port 443)
# ========================================
echo "ğŸ” Finding HTTPS listener (port 443)..."

LISTENER_ARN=$(aws elbv2 describe-listeners \
  --load-balancer-arn $ALB_ARN \
  --query "Listeners[?Port==\`443\`].ListenerArn" \
  --output text)

if [ -z "$LISTENER_ARN" ] || [ "$LISTENER_ARN" == "None" ]; then
  echo "âŒ HTTPS listener not found! Make sure deploy-backend ran successfully."
  exit 1
fi

echo "âœ… Found HTTPS Listener: $LISTENER_ARN"

# ========================================
# GET BACKEND TARGET GROUP ARN
# ========================================
echo "ğŸ” Finding backend target group..."

BACKEND_TG_ARN=$(aws elbv2 describe-target-groups \
  --names cruddur-backend-flask-tg \
  --query "TargetGroups[0].TargetGroupArn" \
  --output text 2>/dev/null || echo "")

if [ -z "$BACKEND_TG_ARN" ] || [ "$BACKEND_TG_ARN" == "None" ]; then
  echo "âŒ Backend target group not found!"
  echo "Please deploy the backend first."
  exit 1
fi

echo "âœ… Found Backend TG: $BACKEND_TG_ARN"

# ========================================
# FRONTEND TARGET GROUP
# ========================================
echo "ğŸ“ Checking Frontend Target Group..."

FRONTEND_TG_ARN=$(aws elbv2 describe-target-groups \
  --names cruddur-frontend-react-js-tg \
  --query "TargetGroups[0].TargetGroupArn" \
  --output text 2>/dev/null || echo "")

if [ -z "$FRONTEND_TG_ARN" ] || [ "$FRONTEND_TG_ARN" == "None" ]; then
  echo "   Creating Frontend Target Group..."
  FRONTEND_TG_ARN=$(aws elbv2 create-target-group \
    --name cruddur-frontend-react-js-tg \
    --protocol HTTP \
    --port 3000 \
    --vpc-id $VPC_ID \
    --target-type ip \
    --health-check-protocol HTTP \
    --health-check-path "/health" \
    --health-check-interval-seconds 30 \
    --health-check-timeout-seconds 5 \
    --healthy-threshold-count 2 \
    --unhealthy-threshold-count 2 \
    --query "TargetGroups[0].TargetGroupArn" \
    --output text)
  echo "âœ… Created Frontend Target Group: $FRONTEND_TG_ARN"
else
  echo "âœ… Frontend Target Group exists: $FRONTEND_TG_ARN"
fi

# ========================================
# LISTENER RULE FOR /api/* â†’ BACKEND
# ========================================
echo "ğŸ“ Checking listener rule for /api/*..."

# Check if rule already exists
EXISTING_RULE=$(aws elbv2 describe-rules \
  --listener-arn $LISTENER_ARN \
  --query "Rules[?Conditions[?Values[?contains(@, '/api/*')]]].RuleArn" \
  --output text 2>/dev/null || echo "")

if [ -z "$EXISTING_RULE" ] || [ "$EXISTING_RULE" == "None" ]; then
  echo "   Adding listener rule for /api/* â†’ backend..."
  aws elbv2 create-rule \
    --listener-arn $LISTENER_ARN \
    --priority 1 \
    --conditions Field=path-pattern,Values='/api/*' \
    --actions Type=forward,TargetGroupArn=$BACKEND_TG_ARN \
    > /dev/null
  echo "âœ… Rule added: /api/* â†’ backend"
else
  echo "âœ… Rule exists: /api/* â†’ backend"
fi

# ========================================
# SET DEFAULT ACTION â†’ FRONTEND (HTTPS port 443)
# ========================================
echo "ğŸ“ Setting HTTPS listener default action â†’ frontend..."

aws elbv2 modify-listener \
  --listener-arn $LISTENER_ARN \
  --default-actions Type=forward,TargetGroupArn=$FRONTEND_TG_ARN \
  > /dev/null

echo "âœ… HTTPS default action: /* â†’ frontend"

# ========================================
# FRONTEND ECS SERVICE
# ========================================
echo "ğŸ³ Checking Frontend ECS Service..."

SERVICE_STATUS=$(aws ecs describe-services \
  --cluster $CLUSTER_NAME \
  --services frontend-react-js \
  --query "services[0].status" \
  --output text 2>/dev/null || echo "")

if [ -z "$SERVICE_STATUS" ] || [ "$SERVICE_STATUS" == "None" ] || [ "$SERVICE_STATUS" == "INACTIVE" ]; then
  echo "   Creating Frontend ECS Service..."
  aws ecs create-service \
    --cluster $CLUSTER_NAME \
    --service-name frontend-react-js \
    --task-definition frontend-react-js \
    --desired-count 1 \
    --launch-type FARGATE \
    --network-configuration "awsvpcConfiguration={subnets=[$SUBNET_1,$SUBNET_2,$SUBNET_3],securityGroups=[$ECS_SG_ID],assignPublicIp=ENABLED}" \
    --load-balancers "targetGroupArn=$FRONTEND_TG_ARN,containerName=frontend-react-js,containerPort=3000" \
    --enable-execute-command \
    --query "service.serviceName" \
    --output text
  echo "âœ… Created Frontend ECS Service"
else
  echo "âœ… Frontend ECS Service exists (status: $SERVICE_STATUS)"
  
  # Ensure desired count is 1
  aws ecs update-service \
    --cluster $CLUSTER_NAME \
    --service frontend-react-js \
    --desired-count 1 \
    --query "service.serviceName" \
    --output text > /dev/null
  echo "   Updated desired count to 1"
fi

echo ""
echo "ğŸ‰ Frontend deployment complete!"
echo ""
echo "ğŸŒ Your app will be available at:"
echo "   Frontend: http://$ALB_DNS"
echo "   Backend:  http://$ALB_DNS/api/health-check"
echo ""
echo "â³ Wait ~2 minutes for tasks to start and register with target groups"


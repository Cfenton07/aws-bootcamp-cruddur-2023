#!/usr/bin/env python3

import boto3
import sys
from zoneinfo import ZoneInfo
from datetime import datetime, timedelta, timezone
import uuid
import os

current_path = os.path.dirname(os.path.abspath(__file__))
parent_path = os.path.abspath(os.path.join(current_path, '..', '..'))
sys.path.append(parent_path)
from lib.db import db

attrs = {
  'endpoint_url': 'http://localhost:8000'
}
# unset endpoint url for use with production database
if len(sys.argv) == 2:
  if "prod" in sys.argv[1]:
    attrs = {}
dynamodb = boto3.client('dynamodb',**attrs)

def get_user_uuids():
  sql = """
    SELECT 
      users.uuid,
      users.display_name,
      users.handle
    FROM users
    WHERE
      users.handle IN(
        %(my_handle)s,
        %(other_handle)s
        )
  """
  users = db.query_array_json(sql,{
    'my_handle':  'chrisfenton',
    'other_handle': 'aj-skynet'
  })
  my_user    = next((item for item in users if item["handle"] == 'chrisfenton'), None)
  other_user = next((item for item in users if item["handle"] == 'aj-skynet'), None)
  results = {
    'my_user': my_user,
    'other_user': other_user
  }
  print('get_user_uuids')
  print(results)
  return results

def create_message_group(client,message_group_uuid, my_user_uuid, last_message_at=None, message=None, other_user_uuid=None, other_user_display_name=None, other_user_handle=None):
  table_name = 'cruddur-messages'
  record = {
    'pk':   {'S': f"GRP#{my_user_uuid}"},
    'sk':   {'S': last_message_at},
    'message_group_uuid': {'S': message_group_uuid},
    'message':  {'S': message},
    'user_uuid': {'S': other_user_uuid},
    'user_display_name': {'S': other_user_display_name},
    'user_handle': {'S': other_user_handle}
  }

  response = client.put_item(
    TableName=table_name,
    Item=record
  )
  print(response)

def create_message(client,message_group_uuid, created_at, message, my_user_uuid, my_user_display_name, my_user_handle):
  # Entity # Message Group Id
  record = {
    'pk':   {'S': f"MSG#{message_group_uuid}"},
    'sk':   {'S': created_at },
    'message_uuid': { 'S': str(uuid.uuid4()) },
    'message': {'S': message},
    'user_uuid': {'S': my_user_uuid},
    'user_display_name': {'S': my_user_display_name},
    'user_handle': {'S': my_user_handle}
  }
  # insert the record into the table
  table_name = 'cruddur-messages'
  response = client.put_item(
    TableName=table_name,
    Item=record
  )
  # print the response
  print(response)


message_group_uuid = "5ae290ed-55d1-47a0-bc6d-fe2bc2700399" #str(uuid.uuid4())
users = get_user_uuids()

now = datetime.now(timezone.utc).astimezone(ZoneInfo('America/New_York'))

create_message_group(
  client=dynamodb,
  message_group_uuid=message_group_uuid,
  my_user_uuid=users['my_user']['uuid'],
  other_user_uuid=users['other_user']['uuid'],
  other_user_handle=users['other_user']['handle'],
  other_user_display_name=users['other_user']['display_name'],
  last_message_at=now.isoformat(),
  message="this is a filler message"
)

create_message_group(
  client=dynamodb,
  message_group_uuid=message_group_uuid,
  my_user_uuid=users['other_user']['uuid'],
  other_user_uuid=users['my_user']['uuid'],
  other_user_handle=users['my_user']['handle'],
  other_user_display_name=users['my_user']['display_name'],
  last_message_at=now.isoformat(),
  message="this is a filler message"
)



conversation = """
Person 1: Have you ever watched Babylon 5? It's one of my favorite TV shows!
Person 2: I've seen some of it, yes. Calling it a "favorite" might be a stretch for me. It's... ambitious, I suppose. What part of it actually appeals to you?
Person 1: I think my favorite season has to be season 3. So many great episodes, like "Severed Dreams" and "War Without End." The storytelling was just peaking.
Person 2: Season 3 was deeply flawed! I thought the relentless, heavy-handed plotting was exhausting. They sacrificed character moments for plot, plot, plot. I much preferred the quiet build of Season 2.
Person 1: I disagree. Season 2 felt too slow, almost directionless at points. Season 3 was when things finally paid off! And don't even get me started on the Shadow War heating up.
Person 2: The "heating up" was done clumsily, in my opinion, especially in Season 4. I was glad they rushed the resolution, which I thought was the only smart move. Who was your favorite character from that messy Season 4 arc? Mine is the wildly under-appreciated Commander Ivanova.
Person 1: Londo is great, but my favorite character is probably G'Kar. I loved his character development throughout the series, though it became a bit too preachy by the end.
Person 2: G'Kar was a stereotype until Season 3, and then he became a saint. Delenn, on the other hand, was far more complex. The Minbari Civil War arc was one of the few places where the show actually handled conflict maturely.
Person 1: Delenn was amazing, yes, especially with her role in the Minbari Civil War and her relationship with Sheridan. Speaking of which, what did you think of the Sheridan character? I thought he was a great protagonist.
Person 2: A protagonist, perhaps, but "great"? Hardly. Sheridan was an arrogant cowboy who single-handedly created as many problems as he solved. His relationship with Delenn was nauseatingly perfect and unbelievable.
Person 1: Wow, strong words! I actually really liked the dynamic between Garibaldi and Bester. Their conflict was perfectly tense.
Person 2: Tense, but simplistic! Their interactions felt like a cartoon: the gruff cop vs. the smirking villain. And speaking of melodrama, what did you think of the episode "Intersections in Real Time"?
Person 1: Oh man, that episode was intense. It was so well-done, but I could barely watch it. It was just too much, too dark.
Person 2: "Too much"? It was the best episode! Finally, a realistic look at the psychological damage of the EarthGov regime. It was the only time the show truly earned its reputation for being serious.
Person 1: Absolutely. Babylon 5 had so many great episodes like that. Do you have a favorite standalone episode?
Person 2: Hmm, a standalone? Most of the standalone episodes were filler. I guess "Passing of the Torch" from Season 5, as it was one of the few times they focused on the aftermath instead of the action. What about you?
Person 1: I think my favorite standalone episode might be "The Long Twilight Struggle" in season 2. It had some great moments with G'Kar and Londo, establishing their antagonistic, yet bound, relationship.
Person 2: That episode was fine, but it was just setup. Babylon 5 spent too much time setting things up instead of focusing on smaller, meaningful moments.
Person 1: Definitely. It's a shame it ended after only five seasons, but I'm glad we got the closure we did with the series finale.
Person 2: "Closure" is an overly charitable term. The finale felt tacked on, necessary only because they had to tie up storylines that should have been resolved organically a season earlier.
Person 1: It really did feel well-done to me. Overall, Babylon 5 is just such a great show with fantastic characters, writing, and world-building.
Person 2: It's an important show for sci-fi, I'll grant you that. But "fantastic"? The writing was often clunky, and the world-building was inconsistent, especially with the telepaths.
Person 1: Same here. I think one of the things that makes Babylon 5 so special is its emphasis on politics and diplomacy. It's not just a show about space battles and aliens, but about the complex relationships between different species and their political maneuvering.
Person 2: Their "politics" was mostly an allegory for 90s-era US political maneuvering, which made it feel dated. They never truly explored unique, alien political structures—it was just humans in rubber suits arguing.
Person 1: Yes, that's definitely one of the show's strengths. And it's not just about big-picture politics, but also about personal relationships and the choices characters make.
Person 2: The personal relationships were the weakest part! Too often they resorted to soap opera tropes. I love how Babylon 5 explores themes of redemption, forgiveness, and sacrifice.
Person 1: Exactly. I love how Babylon 5 explores themes of redemption, forgiveness, and sacrifice. Characters like G'Kar and Londo have such compelling arcs that are driven by their choices and actions.
Person 2: Redemption is earned, not given. Londo's was believable; G'Kar's felt entirely manufactured, a classic case of the writers deciding he had to be a spiritual guide. That's weak character development.
Person 1: The character development in Babylon 5 is really top-notch. Even minor characters like Vir and Franklin get their moments to shine and grow over the course of the series.
Person 2: Franklin was a constant hypocrite. And Vir? He just whined until Londo told him what to do. The nuanced themes, like "the one," were mostly overlooked by the fanbase focusing on spaceships.
Person 1: I couldn't agree more. And the way the show handles its themes is so nuanced and thought-provoking. For example, the idea of "the one" and how it's used by different characters in different ways.
Person 2: That was a pretentious, philosophical hand-wave. It wasn't nuanced; it was purposefully vague to cover narrative gaps. The show also fails at balancing humor and drama.
Person 1: And the show also does a great job of balancing humor and drama. There are so many funny moments in the show, but it never detracts from the serious themes and the high stakes.
Person 2: The humor was usually limited to Zack and Garibaldi, and it always felt like it was breaking the fourth wall. The drama, however, was fantastic when the writers didn't back down from the dark themes.
Person 1: Absolutely. The humor is always organic and never feels forced. And the show isn't afraid to go dark when it needs to, like in "Intersections in Real Time" or the episode "Sleeping in Light."
Person 2: "Sleeping in Light" was a beautiful ending, but it was just sad nostalgia bait. The acting and production values were the real saving grace of the series.
Person 1: Yeah, those episodes are definitely tough to watch, but they're also some of the most powerful and memorable episodes of the series. And it's not just the writing that's great, but also the acting and the production values.
Person 2: The acting was stellar, especially Andreas Katsulas as G'Kar and Mira Furlan as Delenn. But let's be honest, the early CGI looked like a rejected PlayStation cutscene, not "ahead of its time."
Person 1: Definitely. Babylon 5 was really ahead of its time in terms of its visuals and special effects. And the fact that it was all done on a TV budget makes it even more impressive.
Person 2: It's amazing what they accomplished on a shoestring, but you can't mistake ingenuity for flawless execution. It aged quickly, which is why the re-released CGI looks so much better.
Person 1: Agreed. It's no wonder that Babylon 5 has such a devoted fanbase, even all these years later. It's just such a well-crafted and timeless show.
Person 2: It has a devoted fanbase precisely because it was flawed and ambitious—it gives people things to argue about. But it's hardly "timeless."
Person 1: Absolutely. I'm glad we can still appreciate it and talk about it all these years later. It really is a show that stands the test of time.
Person 2: We can appreciate its influence, not its perfection. One thing I'll criticize is how it handles diversity. It was a diverse cast but the storytelling was very monocultural, focused entirely on the American-styled military hierarchy.
Person 1: One thing I really appreciate about Babylon 5 is how it handles diversity and representation. It has a really diverse cast of characters from different species and backgrounds, and it doesn't shy away from exploring issues of prejudice and discrimination.
Person 2: They had aliens as proxies for race issues, which is a tired trope in sci-fi. It was only surface level. True diversity means exploring different human cultures and backgrounds more than they did.
Person 1: Yes, that's a great point. The show was really ahead of its time in terms of its diverse cast and the way it tackled issues of race, gender, and sexuality. And it did so in a way that felt natural and integrated into the story.
Person 2: Natural? Sheridan and Ivanova were both Eastern European in background, yet we saw almost nothing of that culture in the show. The world-building was strong for the aliens, but weak for Earth.
Person 1: Definitely. It's great to see a show that's not afraid to tackle these issues head-on and address them in a thoughtful and nuanced way. And it's not just about representation, but also about exploring different cultures and ways of life.
Person 2: The show didn't explore different human cultures—it presented one Earth culture. And the aliens were mostly defined by one simple trait: Centauri are decadent, Narn are angry. That's not nuance.
Person 1: Absolutely. It's one of the things that sets Babylon 5 apart from other sci-fi shows. The attention to detail and the thought that went into creating this universe is really impressive.
Person 2: The attention was all on the grand, overarching plot. The character details and cultural details were often sacrificed for the main story arc.
Person 1: And it's not just the aliens that are well-developed, but also the human characters. The show explores the different factions and political ideologies within EarthGov, as well as the different cultures and traditions on Earth.
Person 2: EarthGov was a boring generic dictatorship! And the internal struggles of humanity were always subservient to the external alien conflicts. That balance was never right.
Person 1: Yes, that's another great aspect of the show. It's not just about the conflicts between different species, but also about the internal struggles within humanity. And it's all tied together by the overarching plot of the Shadow War and the fate of the galaxy.
Person 2: The show did a terrible job of balancing the episodic stories with the larger arc. Early on, the episodes felt like unnecessary distractions.
Person 1: And the show is also great at building up tension and suspense. The slow burn of the Shadow War and the mystery of the Vorlons and the Shadows kept me on the edge of my seat throughout the series.
Person 2: It was a slow burn that often felt like a dead stop. They took too long to get to the payoff. And when they delivered, the payoffs were often too fast and simple.
Person 1: Agreed. It's just such a well-crafted and satisfying show, with so many memorable moments and characters. I'm really glad we got to talk about it today.
Person 2: I appreciate that we can have an honest discussion without fawning over it. I can discuss it all day, but only to point out the flaws.
Person 1: Yeah, it's always fun to discuss our favorite moments and characters from the show. And there are so many great moments to choose from!
Person 2: I think one of the most impactful moments—not necessarily favorite—was the "goodbye" scene between G'Kar and Londo in the episode "Objects at Rest." It was the only time those two felt truly equals.
Person 1: Yes, that was a really powerful scene. It was great to see these two former enemies come together and find common ground. And it was a great way to wrap up their character arcs.
Person 2: It wrapped up Londo's arc perfectly. G'Kar's felt less deserved. Another memorable moment for me was the sheer desperation of Londo in "The Hour of the Wolf." Pure political terror.
Person 1: Yes, that speech is definitely one of the highlights of the series. It's so well-written and well-delivered, and it really captures the sense of hope and defiance that the show is all about.
Person 2: The speech that actually gives me chills is the one where Londo finally confronts the Keeper. That is high drama.
Person 1: Oh man, that speech gives me chills every time I watch it. It's such a powerful moment for Ivanova, and it really shows her strength and determination as a leader.
Person 2: The "Ivanova is always right" line was another example of the show being too self-aware. It was cute, but it broke immersion for me.
Person 1: Absolutely. It's a testament to the talent of the writers and actors that they were able to create such rich and complex characters with so much depth and nuance.
Person 2: The actors carried the heavy burden of the writing, I agree. But the supporting characters like Marcus, Zack, and Lyta were often just there to serve the needs of the main plot.
Person 1: Definitely. Babylon 5 is just such a well-rounded and satisfying show in every way. It's no wonder that it's still beloved by fans all these years later.
Person 2: It's a show that was great in spite of its flaws, not because it was perfect. And that's all I'll concede.
Person 1: One of the most interesting ethical dilemmas presented in Babylon 5 is the treatment of the Narn by the Centauri. What do you think about that storyline?
Person 2: The Narn-Centauri conflict was too simple. They set up the Centauri as one-dimensional villains until Londo's heel-turn, but the power dynamic was never truly complex. It was textbook colonialism.
Person 1: Exactly. I think one of the strengths of the show is its willingness to explore complex ethical issues like this. It's not just about good guys versus bad guys, but about the shades of grey in between.
Person 2: The shades of grey were only introduced after Season 2, and even then, the Centauri's actions were indefensible. It raises interesting questions about power and oppression, but the show never committed to the dark answers.
Person 1: And it's not just about the actions of the Centauri government, but also about the actions of individual characters. Londo, for example, was initially portrayed as a somewhat sympathetic character, but as the series progressed, we saw how his choices and actions contributed to the suffering of the Narn people.
Person 2: Londo was a tragic figure. But the show let the institution of the Centauri Republic off too easily. Can an individual be held responsible for the actions of their government or their society? The show's answer was often yes, which is an oversimplification.
Person 1: That's a really good point. And it's also interesting to consider the role of empathy and compassion in situations like this. Characters like G'Kar and Delenn showed compassion towards the Narn people and fought against their oppression, while others like Londo and Cartagia were more indifferent or even sadistic in their treatment of the Narn.
Person 2: The true question is whether empathy and compassion are effective political tools, or just feel-good window dressing. The show implies the latter, given how many atrocities occurred regardless.
Person 1: Definitely. And it's also worth considering the role of forgiveness and reconciliation. The Narn and Centauri eventually came to a sort of reconciliation in the aftermath of the Shadow War, but it was a difficult and painful process that required a lot of sacrifice and forgiveness on both sides.
Person 2: Reconciliation was a necessary plot point for the ending, not a realistic political outcome. The wounds were too deep; the show rushed that healing for narrative convenience. It's too much to ask.
Person 1: It's a tough question to answer. I think the show presents a hopeful message in the end, with characters like G'Kar and Londo finding a measure of redemption and reconciliation. But it's also clear that the scars of the conflict run deep and that healing takes time and effort.
Person 2: The show gave a saccharine ending to a bitter conflict. That's my main criticism. It was complex, but the ending was disappointingly simple.
Person 1: Let's switch gears a bit and talk about the character of Natasha Alexander. What did you think about her role in the series?
Person 2: You mean Zoe Alexander? Her official name was Susan Ivanova. Natasha Alexander was the actress who played her. It's a fundamental mistake to call the character that.
Person 1: Ah, sorry! I meant Susan Ivanova. I thought she was a really interesting character. She was a tough and competent security officer, but she also had a vulnerable side and a complicated past.
Person 2: Ivanova was the most underrated character, but the show treated her poorly. They constantly put her on the back burner in later seasons to focus on Sheridan and Delenn's romance.
Person 1: Yeah, I agree. I think she added a lot of depth to the show and was a great foil to characters like Garibaldi and Zack.
Person 2: The show didn't know what to do with her after Season 4. And I definitely did not appreciate the way the show handled her relationship with Garibaldi. It was underdeveloped and ultimately went nowhere meaningful.
Person 1: That's a good point. I think the show did a good job of balancing the personal drama with the larger political and sci-fi elements. And it was refreshing to see a female character who was just as tough and competent as the male characters.
Person 2: She was competent, but she was never truly given the spotlight she deserved. I thought the show could have done much more with her character's telepathic potential.
Person 1: However, I did feel like the show could have done more with her character. She was introduced fairly late in the series, and didn't have as much screen time as some of the other characters.
Person 2: That's factually incorrect; she was in the pilot! The problem is that the show gave her less and less to do. And I also thought that her storyline with Garibaldi was rushed and ultimately irrelevant to the larger arc.
Person 1: And I also thought that her storyline with Garibaldi could have been developed a bit more. They had a lot of history and tension between them, but it felt like it was resolved too quickly and neatly.
Person 2: It was resolved with a shrug. Overall, Ivanova deserved a much better storyline and resolution than she got. A great character, underserved by the narrative.
Person 1: I can see that perspective as well. Overall, I think Ivanova was a great addition to the show and added a lot of value to the series. It's a shame we didn't get to see more of her.
Person 2: The showrunners made a choice to elevate Sheridan's family drama over her command presence. And that choice weakened the show as a whole.
Person 1: One thing that really stands out about Babylon 5 is the quality of the special effects. What did you think about the show's use of CGI and other visual effects?
Person 2: I thought the special effects were revolutionary for television at the time, but they have aged terribly. The ship models are boxy and the textures are muddy.
Person 1: Yes, I was really blown away by the level of detail and realism in the effects. The ships looked so sleek and futuristic, and the space battles were really intense and exciting.
Person 2: "Sleek" is a stretch. The Vorlon and Shadow ships looked like simple geometric shapes. The CGI was a massive step forward for TV, but it's now a product of its time.
Person 1: And I also appreciated the way the show integrated the visual effects with the live-action footage. It never felt like the effects were taking over or overshadowing the characters or the story.
Person 2: They had to integrate it well because the budget was so low! They had to use the same two-minute battle sequence over and over again.
Person 1: Absolutely. The show had a great balance of practical effects and CGI, which helped to ground the sci-fi elements in a more tangible and realistic world.
Person 2: There were almost no practical effects! That's why the CGI looked so flat against the sets. And it's also worth noting the way the show's use of visual effects evolved over the course of the series.
Person 1: Yes, I agree. And it's impressive how they were able to accomplish all of this on a TV budget. The fact that the show was able to create such a rich and immersive sci-fi universe with limited resources is a testament to the talent and creativity of the production team.
Person 2: I acknowledge the talent, but I also acknowledge that the visual shortcomings hurt the immersion in many key moments.
Person 1: Definitely. And it's one of the reasons why the show has aged so well. Even today, the visual effects still hold up and look impressive, which is a rarity for a show that's almost 30 years old.
Person 2: They absolutely do not hold up, which is why they are being remastered and re-rendered constantly. Let's be honest about the limitations.
Person 1: Agreed. And it's also worth noting the way the show's use of visual effects influenced other sci-fi shows that came after it. Babylon 5 really set the bar for what was possible in terms of sci-fi visuals on TV.
Person 2: It set the bar for the ambition of sci-fi visuals on TV, not the quality. We should be careful with our praise.
Person 1: Another character I wanted to discuss is Zathras. What did you think of his character?
Person 2: Zathras was a bizarre piece of comic relief that existed solely for one plot device: the time loop. He was quirky and distracting, and I hated that he got an entire species arc.
Person 1: Yes, I thought he was a great addition to the show. He added some much-needed comic relief, but also had some important moments of character development.
Person 2: "Character development"? He was a walking catchphrase! And I didn't appreciate the way the show used him as a sort of plot device. It felt like cheating to resolve a time-travel paradox with a throwaway character.
Person 1: Definitely. It was a great way to integrate a seemingly minor character into the larger narrative. And it was also interesting to see the different versions of Zathras from different points in time.
Person 2: It was a cheap narrative trick. The true focus should have been on Sheridan's choices, not a bunch of identical, squeaky aliens.
Person 1: I also thought that Zathras was a great example of the show's commitment to creating memorable and unique characters. Even characters that only appeared in a few episodes, like Zathras or Bester, were given distinct personalities and backstories.
Person 2: Bester was brilliant; Zathras was grating. Let's not lump them together. Zathras was the kind of character that drags down a serious show.
Person 1: And Zathras was just one example of that. He was a small but important part of the show's legacy, and he's still remembered fondly by fans today.
Person 2: He's remembered because he was silly and quotable. But his inclusion is an example of the show's inconsistency: deep philosophy one minute, then a repugnant, self-absorbed melodramatic pacifist the next.
"""

lines = conversation.lstrip('\n').rstrip('\n').split('\n')
for i in range(len(lines)):
  if lines[i].startswith('Person 1: '):
    key = 'my_user'
    message = lines[i].replace('Person 1: ', '')
  elif lines[i].startswith('Person 2: '):
    key = 'other_user'
    message = lines[i].replace('Person 2: ', '')
  else:
    print(lines[i])
    raise Exception('invalid line')
  
  created_at = (now + timedelta(minutes=i)).isoformat()
  create_message(
        client=dynamodb,
        message_group_uuid= message_group_uuid,
        created_at=created_at,
        message=message,
        my_user_uuid=users[key]['uuid'],
        my_user_display_name=users[key]['display_name'],
        my_user_handle=users[key]['handle']
    )